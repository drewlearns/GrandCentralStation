#!/bin/bash
set -vex
set -o pipefail

# Remove existing files in the deploy directory
rm -rf ./deploy/*

# Generate Prisma client
npx prisma generate

# Install production node_modules
npm ci --only=production

# Prepare the deploy directory
mkdir -p deploy

# Copy necessary Prisma files and binaries
mkdir -p deploy/node_modules/.prisma/client
cp -r node_modules/@prisma/client deploy/node_modules/@prisma
cp node_modules/.prisma/client/libquery_engine-rhel-openssl-3.0.x.so.node deploy/node_modules/.prisma/client
cp prisma/schema.prisma deploy/

# Copy node_modules to deploy to make it accessible for all functions
cp -r node_modules deploy/

# Process each JavaScript file from the source directory
for file in src/*.js; do
  # Extract the base name of the function file without extension
  func_name=$(basename "$file" .js)
  
  # Create a dedicated directory for each function within deploy
  mkdir -p "deploy/$func_name"

  # Copy the JavaScript file to the function's directory
  cp "$file" "deploy/$func_name/"
  
  # Copy the node_modules and Prisma schema to the function's directory
  cp -r deploy/node_modules "deploy/$func_name/"
  cp deploy/schema.prisma "deploy/$func_name/"

  # Change directory to the function's directory to zip the contents
  pushd "deploy/$func_name"
  zip -r "../$func_name.zip" *
  popd

  # Clean up the function directory but leave node_modules for other functions
  rm -rf "deploy/$func_name"
done

# Change to the deploy directory to list the contents of each zip file
cd deploy

# Verify the contents of the zip files
echo "Contents of the zip files:"
for zip_file in *.zip; do
  echo "Inspecting $zip_file"
  unzip -l "$zip_file"
done
